# Deployment Guide for Render.com

## üöÄ Quick Deploy

This guide explains how to deploy the Retina U-Net Segmentation Dashboard on Render.com.

## üìã Prerequisites

1. A Render.com account (free tier available)
2. Your GitHub repository connected to Render
3. Trained model checkpoint (`best.pth`) - **104 MB file**

## ‚öôÔ∏è Configuration Files

The following files are configured for Render deployment:

- **`render.yaml`** - Render service configuration
- **`Procfile`** - Process file for starting the web service
- **`requirements.txt`** - Python dependencies

## üîß Render Service Settings

### Manual Configuration (if not using render.yaml)

If Render doesn't automatically detect the configuration, set these manually:

1. **Build Command:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Start Command:**
   ```bash
   uvicorn dashboard.app:app --host 0.0.0.0 --port $PORT
   ```

3. **Environment Variables:**
   - `PYTHON_VERSION`: `3.11.4` (or `3.10.x`)
   - `PORT`: Auto-generated by Render

## üì¶ Model Checkpoint Deployment

‚ö†Ô∏è **IMPORTANT**: The trained model checkpoint (`results/checkpoints_unetpp/best.pth`) is **104 MB** and is excluded from Git due to size limits.

### Option 1: Use Git LFS (Recommended for Render)

1. **Install Git LFS:**
   ```bash
   git lfs install
   ```

2. **Track the checkpoint file:**
   ```bash
   git lfs track "results/checkpoints_unetpp/best.pth"
   git add .gitattributes
   ```

3. **Commit and push:**
   ```bash
   git add results/checkpoints_unetpp/best.pth
   git commit -m "Add model checkpoint via Git LFS"
   git push origin main
   ```

### Option 2: Use External Storage

Upload the model to cloud storage and download during startup:

1. Upload `best.pth` to Google Drive, Dropbox, or AWS S3
2. Modify `dashboard/app.py` to download the file on startup
3. Example code to add before model loading:

```python
import urllib.request

def download_checkpoint():
    """Download checkpoint from cloud storage"""
    checkpoint_url = "YOUR_DIRECT_DOWNLOAD_URL"
    checkpoint_path = Path("results/checkpoints_unetpp/best.pth")
    checkpoint_path.parent.mkdir(parents=True, exist_ok=True)
    
    if not checkpoint_path.exists():
        print("Downloading model checkpoint...")
        urllib.request.urlretrieve(checkpoint_url, checkpoint_path)
        print("Checkpoint downloaded successfully!")
```

### Option 3: Deploy Without Model (Demo Mode)

The app is configured to run without the checkpoint (using random weights):
- ‚úÖ App will start successfully
- ‚ö†Ô∏è Predictions will be random/inaccurate
- üí° Good for testing deployment pipeline

## üåê Deployment Steps

### Step 1: Connect Repository

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Click **"New +"** ‚Üí **"Web Service"**
3. Connect your GitHub repository
4. Select the `Retina-Unet` repository

### Step 2: Configure Service

Render should auto-detect settings from `render.yaml`. Verify:

- **Name**: `retina-unet`
- **Environment**: `Python 3`
- **Region**: Choose closest to you
- **Branch**: `main`
- **Build Command**: `pip install -r requirements.txt`
- **Start Command**: `uvicorn dashboard.app:app --host 0.0.0.0 --port $PORT`

### Step 3: Deploy

1. Click **"Create Web Service"**
2. Wait for build to complete (~5-10 minutes)
3. Check logs for any errors

## üîç Troubleshooting

### Build Fails - "Could not open requirements file"

**Solution**: Ensure `requirements.txt` exists in the root directory ‚úÖ (Already fixed)

### Build Fails - "npm run dev" error

**Solution**: 
- Remove any `package.json` from root
- Ensure `render.yaml` or manual settings specify Python runtime
- Set Start Command to: `uvicorn dashboard.app:app --host 0.0.0.0 --port $PORT`

### App Crashes - "Model not found"

**Solution**: Deploy model checkpoint using one of the options above

### Port Binding Issues

**Solution**: The app automatically uses Render's `$PORT` environment variable

### Out of Memory (OOM) Errors

**Solution**: 
- Upgrade to a paid plan with more RAM
- Free tier has 512 MB RAM, PyTorch models need ~1-2 GB
- Consider model optimization/quantization

## üìä Expected Deployment Resources

- **Build Time**: 5-10 minutes
- **RAM Usage**: ~1.5 GB (with model loaded)
- **Disk Space**: ~500 MB (with dependencies)
- **CPU**: 0.1-0.5 cores (CPU inference)

## üéØ Production Checklist

- [ ] `requirements.txt` in root directory
- [ ] `render.yaml` or manual configuration set
- [ ] `Procfile` with correct start command
- [ ] Model checkpoint deployed (Git LFS or cloud storage)
- [ ] Environment variables configured
- [ ] Health check endpoint working (`/api/stats`)
- [ ] Test with sample image upload

## üîó Useful Links

- [Render Documentation](https://render.com/docs)
- [Render Python Guide](https://render.com/docs/deploy-fastapi)
- [Git LFS Setup](https://git-lfs.github.com/)

## üí° Tips

1. **Free Tier Limitations**:
   - Service spins down after 15 min inactivity
   - First request after spin-down takes ~50 seconds
   - Upgrade for always-on service

2. **Monitoring**:
   - Check logs regularly: Dashboard ‚Üí Logs
   - Set up log streaming for production
   - Monitor metrics: Dashboard ‚Üí Metrics

3. **Custom Domain**:
   - Add custom domain in Settings
   - Upgrade to paid plan for custom domains

## üéâ Success!

Once deployed, your app will be available at:
```
https://retina-unet.onrender.com
```

Visit `/dashboard` to access the segmentation interface!

---

**Need Help?** Check Render logs or open an issue on GitHub.
